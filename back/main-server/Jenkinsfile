pipeline {
  agent any
  options { disableConcurrentBuilds(); timestamps() }

  stages {
    stage('Checkout') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Build Backend') {
      steps {
        sh '''
          set -e
          cd back/main-server
          chmod +x gradlew || true
          ./gradlew clean build -x test
          # 또는 도커 빌드라면:
          # cd ../
          # docker compose -f docker-compose.yml --env-file .env build
        '''
      }
    }

    stage('Deploy (copy only)') {
      steps {
        sh '''
          set -e
          # rsync가 없다면: sudo apt-get update && sudo apt-get install -y rsync
          # 배포 폴더로 "복사만" (여기선 git 금지)
          rsync -a --delete \
            --exclude 'back/.env' \
            --exclude 'back/docker-compose.yml' \
            --exclude 'frontend/.env' \
            --exclude '**/uploads/**' \
            --exclude '**/data/**' \
            "$WORKSPACE"/ /home/ubuntu/projects/S13P31A701/

          # 필요 시 권한 한 번만 맞추세요(처음 1회)
          # sudo chown -R ubuntu:ubuntu /home/ubuntu/projects/S13P31A701
        '''
      }
    }
  }
}

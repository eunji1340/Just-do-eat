pipeline {
    agent any

    environment {
        PROJECT_NAME = "JDE-main-server"
        DOCKER_COMPOSE_PATH = "/home/ubuntu/scripts/docker-compose.yml"
        ENV_FILE = "/home/ubuntu/scripts/env.local"
        WORKDIR = "backend/main-server"
    }

    stages {
        stage('üîÅ Clean Workspace') {
            steps {
                echo "Cleaning previous workspace..."
                deleteDir()
            }
        }

        stage('üì¶ Git Clone') {
            steps {
                echo "Cloning project from GitLab..."
                git branch: 'BE',
                    credentialsId: 'nomio4001',
                    url: 'https://lab.ssafy.com/s13-final/S13P31A701.git'
            }
        }

        stage('‚öôÔ∏è Build Spring Boot JAR') {
            steps {
                echo "Building backend JAR file..."
                dir("${WORKDIR}") {
		    sh 'chmod +x gradlew'     
                    sh './gradlew clean build -x test'
                }
            }
        }

        stage('üê≥ Build & Deploy Docker Container') {
            steps {
                echo "Stopping old container and rebuilding..."
                sh """
                cd /home/ubuntu/scripts
                docker compose --env-file ${ENV_FILE} down
                docker compose --env-file ${ENV_FILE} build
                docker compose --env-file ${ENV_FILE} up -d
                """
            }
        }

        stage('‚úÖ Verify Deployment') {
            steps {
                echo "Checking backend container status..."
                sh "docker ps | grep ${PROJECT_NAME} || echo 'Container not running'"
            }
        }
    }

    post {
        success {
            echo "‚úÖ Backend deployment completed successfully!"
        }
        failure {
            echo "‚ùå Backend pipeline failed. Please check Jenkins logs."
        }
    }
}

pipeline {
    agent any

    environment {

        APP_NAME = "jde-frontend"
        NGINX_CONTAINER = "JDE-nginx"
        WORK_DIR = "./frontend/JDE"
    }

    stages {
        stage('Update') {
            steps {
        withCredentials([usernamePassword(credentialsId: 'nomio4001', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
          sh '''

            git config --global user.name "$GIT_USER"
            git config --global user.email "$GIT_USER@naver.com"
            git remote set-url origin https://$GIT_USER:$GIT_PASS@lab.ssafy.com/s13-final/S13P31A701.git


            git fetch origin FE
            git checkout FE
	    git reset --hard origin/FE
          '''
        }
      }
    }  

        stage('Build Frontend') {
            agent {
              docker { image 'node:20' }
              }
            steps {
                sh '''
		    cd ${WORK_DIR}

                    echo "ğŸ§¹ Clean node_modules and lockfile..."
      		    rm -rf node_modules package-lock.json
      		    npm cache clean --force

      		    echo "ğŸ“¦ Installing dependencies (fresh)..."
      		    npm install

     		    echo "ğŸ—ï¸ Building frontend..."
      		    npm run build
                '''
            }
        }

        stage('Deploy to Nginx') {
            steps {
                sh '''
                    echo "ğŸš€ Deploying build files to Nginx container..."

                    # Nginx ì»¨í…Œì´ë„ˆê°€ ì‹¤ì œ ì„œë¹„ìŠ¤ ë‹´ë‹¹
                    docker cp $WORKSPACE/${WORK_DIR}/dist/. ${NGINX_CONTAINER}:/usr/share/nginx/html/

                    # nginx reloadë¡œ ìƒˆ íŒŒì¼ ë°˜ì˜
                    docker exec ${NGINX_CONTAINER} nginx -s reload

                    echo "âœ… Deployment completed successfully!"
                '''
            }
        }
    }

    post {
        always {
            echo "ğŸ§¹ Cleaning workspace..."
            cleanWs()
        }
    }
}
